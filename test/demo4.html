<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—èªé»æ“Šå­¸ç¿’ Demo - èªéŸ³è¾¨è­˜ç‰ˆ</title>
    <style>
        /* ä¿æŒåŸæœ‰æ¨£å¼ */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f4f4f9;
            color: #333;
        }
        #game-container {
            width: 90%;
            max-width: 600px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        #progress-bar {
            height: 10px;
            background-color: #ddd;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        #progress {
            height: 100%;
            width: 0%;
            background-color: #4CAF50;
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        #audio-hint {
            font-size: 1.2em;
            margin-bottom: 20px;
            color: #333;
        }
        #options-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 30px;
            /* æ–°å¢ï¼šç”¨æ–¼é–å®šé¸é …çš„é€æ˜é®ç½© */
            position: relative; 
        }
        .options-locked::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.5); /* åŠé€æ˜é®ç½© */
            cursor: not-allowed;
            z-index: 10;
        }
        .option-block {
            padding: 20px 10px;
            background-color: #007bff;
            color: white;
            font-size: 1.1em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .option-block:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
        /* éŒ¯èª¤é»æ“Šçš„åé¥‹æ¨£å¼ */
        .wrong-answer {
            animation: shake 0.5s;
            background-color: #dc3545 !important;
        }
        @keyframes shake {
            0%, 100% {transform: translateX(0);}
            20%, 60% {transform: translateX(-10px);}
            40%, 80% {transform: translateX(10px);}
        }
        .final-screen {
            font-size: 1.5em;
            color: #28a745;
            margin-top: 50px;
        }
        #replay-button {
            padding: 10px 20px;
            margin-top: 20px;
            background-color: #ffc107;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        #mode-selector {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
        }
        #mode-selector label {
            margin-right: 15px;
            font-weight: bold;
        }
        #mode-selector input[type="radio"] {
            margin-right: 5px;
        }
        #mode-selector input[type="radio"]:checked + label {
            color: #007bff;
        }
        /* æ–°å¢ï¼šéº¥å…‹é¢¨æŒ‰éˆ•æ¨£å¼ */
        #mic-button {
            padding: 15px; 
            font-size: 1.5em; 
            cursor: pointer; 
            background-color: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 50%;
        }
        #mic-button.recording {
            background-color: #dc3545;
            animation: pulse 1s infinite;
        }
        /* æ–°å¢ï¼šå–‡å­æŒ‰éˆ•æ¨£å¼ï¼Œèˆ‡éº¥å…‹é¢¨æŒ‰éˆ•ä¿æŒä¸€è‡´ */
        /* #play-button {
            padding: 15px; 
            font-size: 1.5em; 
            cursor: pointer; 
            background-color: #6c757d; 
            color: white; 
            border: none; 
            border-radius: 50%;
        } */
        @keyframes pulse {
            0% {box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7);}
            70% {box-shadow: 0 0 0 10px rgba(220, 53, 69, 0);}
            100% {box-shadow: 0 0 0 0 rgba(220, 53, 69, 0);}
        }
    </style>
</head>
<body>

<div id="game-container">
    <h1>æ—èªå­¸ç¿’éŠæˆ² Demo - èªéŸ³äº’å‹•ç‰ˆ</h1>
    <div id="mode-selector">
        <label>å‡ºé¡Œæ¨¡å¼ï¼š</label>
        <input type="radio" id="mode-sequential" name="game-mode" value="sequential" checked>
        <label for="mode-sequential">é †åºæ¨¡å¼</label>
        <input type="radio" id="mode-random" name="game-mode" value="random">
        <label for="mode-random">éš¨æ©Ÿæ¨¡å¼</label>
    </div>
    <div id="progress-bar"><div id="progress"></div></div>
    
    <div id="audio-hint">è«‹é¸æ“‡æ¨¡å¼ä¸¦é»æ“Šå–‡å­åœ–æ¨™é–‹å§‹éŠæˆ²ã€‚</div>

   <div style="display:flex; justify-content:center; align-items:center;">
    <!-- <button id="play-button" onclick="playAudio()" >ğŸ”Š</button> -->
    <!-- <button id="play-button" onclick="playAudio()" style="padding: 15px; font-size: 1.5em; cursor: pointer; background-color: #6c757d; color: white; border: none; border-radius: 50%; margin-right: 40px;">ğŸ”Š</button> -->
    <button id="play-button" onclick="playAudio()" style="padding: 15px; font-size: 1.5em; cursor: pointer; background-color: #6c757d; color: white; border: none; border-radius: 50%; margin-right: 40px;">ğŸ”Š</button>
    <button id="mic-button" onclick="startSpeechRecognition()" disabled>ğŸ¤</button>
   </div>

    <div id="options-container" class="options-locked"> 
        </div>
    
    <div id="feedback" style="margin-top: 20px; font-size: 1.2em;"></div>
</div>

<script>
// ----------------------------------------------------------------------
// æ­¥é©Ÿ 1: éŠæˆ²è³‡æ–™è¨­å®š - å¢åŠ ç¾…é¦¬æ‹¼éŸ³ romanization
// ----------------------------------------------------------------------
const gameData = [
    { word: "åª½åª½", audioFile: "mama.mp3", correctText: "åª½åª½", romanization: "kina" }, 
    { word: "èŠ‹é ­", audioFile: "taro.mp3", correctText: "èŠ‹é ­", romanization: "vasa" },
    { word: "å¤ªé™½", audioFile: "sun.mp3", correctText: "å¤ªé™½", romanization: "qadaw" },
];

// ----------------------------------------------------------------------
// æ­¥é©Ÿ 2: éŠæˆ²ç‹€æ…‹è®Šæ•¸
// ----------------------------------------------------------------------
let currentLevel = 0; 
let currentGameData = []; 
const totalOriginalLevels = gameData.length; 
let isRecognizing = false; // è¿½è¹¤èªéŸ³è¾¨è­˜ç‹€æ…‹

const optionsContainer = document.getElementById('options-container');
const progressElement = document.getElementById('progress');
const feedbackElement = document.getElementById('feedback');
const audioHintElement = document.getElementById('audio-hint');
const playButton = document.getElementById('play-button');
const micButton = document.getElementById('mic-button'); // å–å¾—éº¥å…‹é¢¨æŒ‰éˆ•
let currentAudio = null;

// ----------------------------------------------------------------------
// æ­¥é©Ÿ 3: é€šç”¨å‡½å¼ (åŒ…å«éš¨æ©Ÿæ’åºå’Œå‹•æ…‹é¸é …ç”Ÿæˆ)
// ----------------------------------------------------------------------
function shuffleArray(array) {
    const shuffled = [...array]; 
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function getDistractorOptions(correctWord) {
    const allWords = gameData.map(data => data.word); 
    let distractors = allWords.filter(word => word !== correctWord); 
    const numDistractorsNeeded = Math.min(2, distractors.length);
    distractors = shuffleArray(distractors).slice(0, numDistractorsNeeded); 
    
    let options = [{ text: correctWord, isCorrect: true }];

    distractors.forEach(word => {
        options.push({ text: word, isCorrect: false });
    });

    while (options.length < 3) {
        options.push({ text: 'éŒ¯èª¤é¸é …' + options.length, isCorrect: false });
    }
    return shuffleArray(options);
}

// ----------------------------------------------------------------------
// æ­¥é©Ÿ 4: èªéŸ³è¾¨è­˜æ ¸å¿ƒåŠŸèƒ½ - æ–°å¢ï¼
// ----------------------------------------------------------------------
// æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´èªéŸ³è¾¨è­˜
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

function setupSpeechRecognition() {
    if (!SpeechRecognition) {
        alert("æŠ±æ­‰ï¼æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API èªéŸ³è¾¨è­˜åŠŸèƒ½ã€‚æ­¤å°ˆé¡Œçš„äº’å‹•éƒ¨åˆ†å¯èƒ½ç„¡æ³•é‹è¡Œã€‚è«‹å˜—è©¦ä½¿ç”¨ Chrome ç€è¦½å™¨ã€‚");
        micButton.disabled = true;
        return;
    }
    
    recognition = new SpeechRecognition();
    recognition.continuous = false; // åªéŒ„ä¸€æ¬¡
    recognition.lang = 'en-US'; // âš ï¸ æ³¨æ„ï¼šæ­¤è™•è¨­å®šç‚ºè‹±æ–‡ï¼Œä»¥ç›¡å¯èƒ½æº–ç¢ºè¾¨è­˜ç¾…é¦¬æ‹¼éŸ³
    recognition.interimResults = false;

    // å•Ÿå‹•éŒ„éŸ³
    recognition.onstart = () => {
        isRecognizing = true;
        micButton.classList.add('recording');
        micButton.disabled = false;
        audioHintElement.textContent = "ğŸ‘‚ æ­£åœ¨è†è½ä¸­... è«‹èªªå‡ºæ—èªçš„ç¾…é¦¬æ‹¼éŸ³ã€‚";
    };

    // éŒ„éŸ³éŒ¯èª¤
    recognition.onerror = (event) => {
        isRecognizing = false;
        micButton.classList.remove('recording');
        micButton.disabled = false;
        audioHintElement.textContent = `âŒ èªéŸ³è¾¨è­˜éŒ¯èª¤ï¼š${event.error}ã€‚è«‹å†æ¬¡é»æ“Šéº¥å…‹é¢¨é‡è©¦ã€‚`;
        console.error('Speech Recognition Error:', event.error);
    };

    // éŒ„éŸ³çµæŸ
    recognition.onend = () => {
        isRecognizing = false;
        micButton.classList.remove('recording');
    };

    // è¾¨è­˜çµæœ
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript.toLowerCase().trim();
        checkPronunciation(transcript);
    };
}

function startSpeechRecognition() {
    if (isRecognizing) {
        recognition.stop();
        return;
    }
    // æ¯æ¬¡é–‹å§‹è¾¨è­˜å‰ï¼Œå…ˆé‡è¨­æç¤ºæ–‡å­—
    audioHintElement.textContent = "è«‹å°è‘—éº¥å…‹é¢¨æ¸…æ¥šåœ°èªªå‡ºç¾…é¦¬æ‹¼éŸ³...";
    try {
        recognition.start();
    } catch (e) {
        console.error("Recognition start error:", e);
        audioHintElement.textContent = "ç„¡æ³•å•Ÿå‹•éº¥å…‹é¢¨ã€‚è«‹ç¢ºèªå·²æˆäºˆç¶²ç«™éº¥å…‹é¢¨æ¬Šé™ã€‚";
    }
}

function checkPronunciation(playerTranscript) {
    const currentData = currentGameData[currentLevel];
    // é æœŸæ­£ç¢ºçš„ç¾…é¦¬æ‹¼éŸ³
    const expectedRomanization = currentData.romanization.toLowerCase().trim();

    // åˆ¤æ–·é‚è¼¯ï¼šå¦‚æœè¾¨è­˜çµæœåŒ…å«é æœŸæ‹¼éŸ³ (å®¹è¨±ä¸€äº›é›œéŸ³)
    const isCorrectPronunciation = playerTranscript.includes(expectedRomanization) 
                                   || expectedRomanization.includes(playerTranscript); 
    
    if (isCorrectPronunciation) {
        // å”¸å°äº†ï¼šè§£é–é¸é …ï¼Œé€²å…¥é»æ“Šéšæ®µ
        audioHintElement.textContent = `âœ… ç™¼éŸ³æ­£ç¢ºï¼è¾¨è­˜çµæœç‚ºï¼š${playerTranscript}ã€‚ç¾åœ¨è«‹é»æ“Šå°æ‡‰çš„åœ–ç‰‡æ–¹å¡Šã€‚`;
        micButton.disabled = true;
        optionsContainer.classList.remove('options-locked'); // è§£é–é¸é …
    } else {
        // å”¸éŒ¯äº†ï¼šé–å®šé¸é …ï¼Œå¿…é ˆé‡å”¸
        audioHintElement.textContent = `âŒ ç™¼éŸ³ä¸æ­£ç¢ºï¼è¾¨è­˜çµæœç‚ºï¼š${playerTranscript}ã€‚è«‹å†æ¬¡é»æ“Šéº¥å…‹é¢¨é‡è©¦ã€‚`;
        micButton.disabled = false;
        optionsContainer.classList.add('options-locked'); // ä¿æŒé–å®š
    }
}


// ----------------------------------------------------------------------
// æ­¥é©Ÿ 5: æ ¸å¿ƒåŠŸèƒ½ - æ’­æ”¾éŸ³æª” (ç¾åœ¨éœ€è¦å•Ÿç”¨éº¥å…‹é¢¨)
// ----------------------------------------------------------------------
function playAudio() {
    if (currentLevel >= currentGameData.length) return;
    
    const currentData = currentGameData[currentLevel];
    
    // 1. æ’­æ”¾éŸ³æª”
    const audioPath = 'audio/' + currentData.audioFile;
    currentAudio = new Audio(audioPath);

    currentAudio.play().catch(error => {
        console.error("Audio playback failed:", error);
        alert("èªéŸ³æ’­æ”¾å¤±æ•—ï¼Œè«‹ç¢ºèªéŸ³æª”æª”æ¡ˆåç¨±èˆ‡è·¯å¾‘æ˜¯å¦æ­£ç¢ºã€‚");
    });
    
    // 2. æ’­æ”¾å®Œç•¢å¾Œï¼Œå•Ÿç”¨éº¥å…‹é¢¨æŒ‰éˆ•
    currentAudio.onended = () => {
        micButton.disabled = false;
        audioHintElement.textContent = `è«‹é»æ“Š ğŸ¤ éº¥å…‹é¢¨ï¼Œå”¸å‡ºç¾…é¦¬æ‹¼éŸ³ã€Œ${currentData.romanization}ã€ã€‚`;
    };

    playButton.disabled = true;
    currentAudio.play().finally(() => {
        playButton.disabled = false;
    });

    // å‰›é€²å…¥é—œå¡æ™‚ï¼Œé¸é …å¿…é ˆé–å®š
    optionsContainer.classList.add('options-locked'); 
    micButton.disabled = true; 
}


// ----------------------------------------------------------------------
// æ­¥é©Ÿ 6: æ ¸å¿ƒåŠŸèƒ½ - æª¢æŸ¥ç­”æ¡ˆèˆ‡åˆ‡æ› (ä¿æŒä¸è®Š)
// ----------------------------------------------------------------------
function checkAnswer(isCorrect, blockElement) {
    if (currentLevel >= currentGameData.length) return;

    if (isCorrect) {
        feedbackElement.textContent = "âœ… ç­”å°äº†ï¼é€²å…¥ä¸‹ä¸€é—œï¼";
        // ç­”å°å¾Œï¼Œç¦ç”¨éº¥å…‹é¢¨
        micButton.disabled = true; 
        setTimeout(nextLevel, 1000); 
    } else {
        feedbackElement.textContent = "âŒ ç­”éŒ¯äº†ï¼è«‹å†è½ä¸€æ¬¡ä¸¦é‡æ–°å”¸å‡ºã€‚";
        blockElement.classList.add('wrong-answer');
        
        setTimeout(() => {
            blockElement.classList.remove('wrong-answer');
        }, 500);
        
        // ç­”éŒ¯å¾Œï¼Œé‡æ–°é–å®šé¸é …ï¼Œè®“ç©å®¶å¿…é ˆé‡å”¸
        optionsContainer.classList.add('options-locked');
        micButton.disabled = false; // å•Ÿç”¨éº¥å…‹é¢¨è®“ç©å®¶é‡è©¦
        setTimeout(playAudio, 1000); 
    }
}

function nextLevel() {
    currentLevel++;
    renderLevel();
}

// ----------------------------------------------------------------------
// æ­¥é©Ÿ 7: æ¸²æŸ“é—œå¡ (ä¿æŒä¸è®Š)
// ----------------------------------------------------------------------
function renderLevel() {
    if (currentLevel >= currentGameData.length) {
        // éŠæˆ²çµæŸ
        optionsContainer.innerHTML = `<div class="final-screen">æ­å–œï¼ä½ å·²å®Œæˆæ‰€æœ‰é—œå¡ï¼<br>ğŸ‰ å°ˆé¡Œ Demo æˆåŠŸé‹è¡Œ ğŸ‰</div>`;
        feedbackElement.textContent = "";
        playButton.style.display = 'none';
        micButton.style.display = 'none';
        audioHintElement.textContent = "é»æ“Šä¸‹æ–¹çš„æŒ‰éˆ•é‡æ–°é–‹å§‹ã€‚";
        
        const restartButton = document.createElement('button');
        restartButton.id = 'replay-button';
        restartButton.textContent = 'é‡æ–°é–‹å§‹';
        restartButton.onclick = startGame; 
        optionsContainer.appendChild(restartButton);
        
        updateProgress();
        return;
    }

    const currentData = currentGameData[currentLevel];
    optionsContainer.innerHTML = ''; 
    feedbackElement.textContent = "";
    playButton.style.display = 'block';
    micButton.style.display = 'block'; // ç¢ºä¿éº¥å…‹é¢¨æŒ‰éˆ•é¡¯ç¤º

    // é–å®šé¸é …
    optionsContainer.classList.add('options-locked');

    // ğŸ”‘ é—œéµæ­¥é©Ÿï¼šå‹•æ…‹ç”Ÿæˆå¸¶æœ‰æ“¾äº‚é¸é …çš„åˆ—è¡¨
    const dynamicOptions = getDistractorOptions(currentData.word);

    // æ¸²æŸ“é¸é …æ–¹å¡Š
    dynamicOptions.forEach(option => {
        const block = document.createElement('div');
        block.classList.add('option-block');
        block.textContent = option.text; // Demo ä½¿ç”¨æ–‡å­—
        
        // åªæœ‰åœ¨é¸é …è§£é–æ™‚æ‰èƒ½é»æ“Š
        block.onclick = () => checkAnswer(option.isCorrect, block);
        
        optionsContainer.appendChild(block);
    });

    updateProgress();
    playAudio(); 
}

// ----------------------------------------------------------------------
// æ­¥é©Ÿ 8: éŠæˆ²å•Ÿå‹•èˆ‡æ¨¡å¼ç®¡ç†
// ----------------------------------------------------------------------
function updateProgress() {
    const percentage = (currentLevel / currentGameData.length) * 100; 
    progressElement.style.width = `${percentage}%`;
}

function startGame() {
    const modeSelector = document.querySelector('input[name="game-mode"]:checked');
    const isRandom = modeSelector && modeSelector.value === 'random';

    if (isRandom) {
        currentGameData = shuffleArray(gameData);
        audioHintElement.textContent = "å·²è¨­å®šç‚ºéš¨æ©Ÿæ¨¡å¼ï¼Œè«‹é»æ“Šå–‡å­åœ–æ¨™é–‹å§‹ã€‚";
    } else {
        currentGameData = [...gameData]; 
        audioHintElement.textContent = "å·²è¨­å®šç‚ºé †åºæ¨¡å¼ï¼Œè«‹é»æ“Šå–‡å­åœ–æ¨™é–‹å§‹ã€‚";
    }
    
    currentLevel = 0;
    renderLevel();
}

document.addEventListener('DOMContentLoaded', function() {
    // åˆå§‹åŒ–èªéŸ³è¾¨è­˜
    setupSpeechRecognition();
    
    const modeInputs = document.querySelectorAll('input[name="game-mode"]');
    modeInputs.forEach(input => {
        input.addEventListener('change', startGame);
    });
    
    startGame();
});
</script>
</body>
</html>